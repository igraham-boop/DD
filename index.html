<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>The Double Take Dash</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  margin: 0;
  background: #111;
  font-family: monospace;
  color: white;
}
canvas {
  display: block;
  margin: auto;
  border: 4px solid white;
  background: #d2a86b;
  image-rendering: pixelated;
}
#overlay {
  text-align: center;
  margin-top: 10px;
}
input, button {
  font-size: 18px;
  padding: 6px;
  margin: 4px;
}
</style>
</head>
<body>

<canvas id="game" width="512" height="512"></canvas>
<div id="overlay"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCKe5hkPiCTI0pF6yMAbTYpL5_woZqb07o",
  authDomain: "gculik-fda9f.firebaseapp.com",
  projectId: "gculik-fda9f"
});
const db = firebase.firestore();

/* ================= SETUP ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");

canvas.setAttribute("tabindex","0");
canvas.focus();
canvas.onclick = () => canvas.focus();

const TILE=32, COLS=16, ROWS=16;

let state="title";
let selectedChar=0;
let countdown=3;
let score=0;
let lives=3;

const player={x:8,y:14};
let left=false,right=false;
let obstacles=[],bonuses=[],hearts=[];

/* ================= AUDIO ================= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
let musicInterval=null;

function tone(f,d,t="square",v=0.08){
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type=t; o.frequency.value=f;
  g.gain.value=v;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+d);
}

function startIntroMusic(){
  if(musicInterval) return;
  musicInterval=setInterval(()=>{
    tone(220,0.15); setTimeout(()=>tone(330,0.15),200);
    setTimeout(()=>tone(440,0.15),400);
  },800);
}

function stopIntroMusic(){
  clearInterval(musicInterval);
  musicInterval=null;
}

/* ================= INPUT ================= */
document.addEventListener("keydown",e=>{
  if(audioCtx.state==="suspended") audioCtx.resume();

  if(state==="title" && e.code==="Space"){
    stopIntroMusic();
    state="select";
  }
  else if(state==="select"){
    if(e.key==="ArrowLeft") selectedChar=0;
    if(e.key==="ArrowRight") selectedChar=1;
    if(e.code==="Space") state="instructions";
  }
  else if(state==="instructions" && e.code==="Space"){
    state="countdown"; countdown=3;
    setTimeout(countTick,1000);
  }
  else if(state==="playing"){
    if(e.key==="ArrowLeft") left=true;
    if(e.key==="ArrowRight") right=true;
  }
});
document.addEventListener("keyup",e=>{
  if(e.key==="ArrowLeft") left=false;
  if(e.key==="ArrowRight") right=false;
});

/* ================= COUNTDOWN ================= */
function countTick(){
  tone(220,0.1);
  countdown--;
  if(countdown>0) setTimeout(countTick,1000);
  else state="playing";
}

/* ================= UPDATE ================= */
function update(){
  if(state!=="playing") return;

  if(left&&player.x>0) player.x--;
  if(right&&player.x<COLS-1) player.x++;

  if(Math.random()<0.05) obstacles.push({x:Math.random()*COLS|0,y:0});
  if(Math.random()<0.03) bonuses.push({x:Math.random()*COLS|0,y:0});
  if(Math.random()<0.02 && lives<3) hearts.push({x:Math.random()*COLS|0,y:0});

  [...obstacles,...bonuses,...hearts].forEach(o=>o.y+=0.25);

  obstacles=obstacles.filter(o=>{
    if(Math.floor(o.y)===player.y && o.x===player.x){
      lives--; tone(120,0.2,"sawtooth");
      if(lives<=0) endGame();
      return false;
    }
    return o.y<ROWS;
  });

  bonuses=bonuses.filter(b=>{
    if(Math.floor(b.y)===player.y && b.x===player.x){
      score+=300; tone(880,0.15);
      return false;
    }
    return b.y<ROWS;
  });

  hearts=hearts.filter(h=>{
    if(Math.floor(h.y)===player.y && h.x===player.x){
      lives++; tone(660,0.15);
      return false;
    }
    return h.y<ROWS;
  });

  score++;
}

/* ================= END ================= */
function endGame(){
  state="gameover";
  tone(60,0.5);
  overlay.innerHTML=`<h2>Game Over</h2><p>Score: ${score}</p>`;
}

/* ================= DRAW ================= */
function drawHeart(x,y){
  ctx.fillStyle="red";
  ctx.beginPath();
  ctx.arc(x-4,y,5,0,Math.PI*2);
  ctx.arc(x+4,y,5,0,Math.PI*2);
  ctx.lineTo(x,y+8);
  ctx.fill();
}

function drawPlayer(x,y,isVon){
  ctx.fillStyle="#ffeb3b"; ctx.fillRect(x+8,y,16,16);
  if(isVon){ctx.fillStyle="#5d4037";ctx.fillRect(x+6,y-4,20,10);}
  ctx.fillStyle="#000";ctx.fillRect(x+4,y+16,24,24);
  ctx.fillStyle=isVon?"#388e3c":"#4caf50";ctx.fillRect(x+6,y+22,20,14);
  ctx.fillStyle="#333";ctx.fillRect(x+8,y+40,16,16);
}

function draw(){
  ctx.clearRect(0,0,512,512);
  ctx.textAlign="center";

  if(state==="title"){
    startIntroMusic();
    ctx.fillStyle="#ffd700";
    ctx.font="44px monospace";
    ctx.fillText("THE DOUBLE TAKE",256,220);
    ctx.fillStyle="#00e5ff";
    ctx.fillText("DASH",256,270);
    ctx.fillStyle="#fff";
    ctx.font="18px monospace";
    ctx.fillText("Press SPACE",256,340);
  }

  if(state==="select"){
    ctx.font="26px monospace";
    ctx.fillText("CHOOSE YOUR TWIN",256,60);
    drawPlayer(140,220,false);
    drawPlayer(320,220,true);
    ctx.strokeStyle="#ffd700";
    ctx.strokeRect(selectedChar?304:124,204,64,96);
    ctx.font="18px monospace";
    ctx.fillText("VINNY",172,330);
    ctx.fillText("VON",352,330);
    ctx.fillText("SPACE to continue",256,430);
  }

  if(state==="instructions"){
    ctx.font="22px monospace";
    ctx.fillText("HOW TO PLAY",256,120);
    ctx.font="18px monospace";
    ctx.fillText("Arrow Keys = Move",256,180);
    ctx.fillText("Volleyballs = Damage",256,220);
    ctx.fillText("Hearts = Extra Life",256,260);
    ctx.fillStyle="#00b0ff";
    ctx.fillText("COOL Bonus = Big Points",256,300);
    ctx.fillStyle="#fff";
    ctx.fillText("Press SPACE",256,380);
  }

  if(state==="countdown"){
    ctx.font="80px monospace";
    ctx.fillText(countdown,256,280);
  }

  if(state==="playing"||state==="gameover"){
    for(let r=0;r<ROWS;r++)
      for(let c=0;c<COLS;c++){
        ctx.fillStyle=(r+c)%2?"#c49f6c":"#d2a86b";
        ctx.fillRect(c*TILE,r*TILE,TILE,TILE);
      }

    drawPlayer(player.x*TILE,player.y*TILE,selectedChar===1);

    obstacles.forEach(o=>{
      ctx.fillStyle="#fff";
      ctx.beginPath();
      ctx.arc(o.x*TILE+16,o.y*TILE+16,14,0,Math.PI*2);
      ctx.fill();
    });

    bonuses.forEach(b=>{
      ctx.fillStyle="#00b0ff";
      ctx.font="bold 16px monospace";
      ctx.fillText("COOL",b.x*TILE+16,b.y*TILE+18);
    });

    hearts.forEach(h=>{
      drawHeart(h.x*TILE+16,h.y*TILE+16);
    });

    ctx.textAlign="left";
    ctx.fillStyle="#fff";
    ctx.font="18px monospace";
    ctx.fillText("Score: "+score,10,26);
    ctx.fillText("Lives: "+lives,10,48);
  }
}

/* ================= LOOP ================= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
